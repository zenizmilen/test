--CONFIG
getgenv().webhook = "https://discord.com/api/webhooks/1412573439662755991/totZqF-N-QytqQxFKM4GirpDF4j1Hjjyiy_a-RXBUdnjtg-4MAfW-Ve0h054IyvH8WiG"
getgenv().websiteEndpoint = nil

-- Allowed place IDs
local allowedPlaceIds = {
    [96342491571673] = true, -- New Players Server
    [109983668079237] = true -- Normal
}

getgenv().TargetPetNames = {
    "Noobini Pizzanini",
    "Burguro And Fryuro",
    "Celularcini Viciosini",
    "Chicleteira Bicicleteira",
    "Dragon Cannelloni",
    "Esok Sekolah",
    "Garama and Madundung",
    "Graipuss Medussi",
    "Ketchuru and Musturu",
    "Ketupat Kepat",
    "La Extinct Grande",
    "La Grande Combinasion",
    "La Sahur Combinasion",
    "La Secret Combinasion",
    "La Spooky Grande",
    "La Supreme Combinasion",
    "Las Sis",
    "Los Bros",
    "Los Chicleteiras",
    "Los Combinasionas",
    "Los Hotspotsitos",
    "Los Mobilis",
    "Los Nooo My Hotspotsitos",
    "Los Primos",
    "Los Tacoritas",
    "Mariachi Corazoni",
    "Meowl",
    "Mieteteira Bicicleteira",
    "Money Money Puggy",
    "Nooo My Hotspot",
    "Nuclearo Dinossauro",
    "Pot Hotspot",
    "Quesadilla Crocodila",
    "Spaghetti Tualetti",
    "Strawberry Elephant",
    "Tang Tang Kelentang",
    "Tacorita Bicicleta",
    "Tictac Sahur",
    "To to to Sahur",
    "Tralaledon",
}

-- SERVICES
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local LocalPlayer = Players.LocalPlayer

-- PRIVATE SERVER CHECK (works for VIP + Reserved)
local function isPrivateServer()
    return (game.PrivateServerId and game.PrivateServerId ~= "")
        or (game.VIPServerId and game.VIPServerId ~= "")
end

local function buildJoinLink(placeId, jobId)
    return string.format(
        "https://chillihub1.github.io/chillihub-joiner/?placeId=%d&gameInstanceId=%s",
        placeId,
        jobId
    )
end

-- KICK CHECKS
if isPrivateServer() then
    LocalPlayer:Kick("Kicked because in private server")
    return
elseif not allowedPlaceIds[game.PlaceId] then
    local joinLink = buildJoinLink(game.PlaceId, game.JobId)
    LocalPlayer:Kick("Kicked because wrong game\nClick to join server:\n" .. joinLink)
    return
end

-- FORMAT MONEY VALUE
local function formatMoney(value)
    if value >= 1e12 then
        return string.format("$%.1fT/s", value / 1e12)
    elseif value >= 1e9 then
        return string.format("$%.1fB/s", value / 1e9)
    elseif value >= 1e6 then
        return string.format("$%.1fM/s", value / 1e6)
    elseif value >= 1e3 then
        return string.format("$%.1fK/s", value / 1e3)
    else
        return string.format("$%.1f/s", value)
    end
end

-- GET GENERATION VALUE
local function getGenerationValue(petModel)
    -- Procura o objeto Generation em todos os descendentes
    for _, descendant in pairs(petModel:GetDescendants()) do
        if descendant.Name == "Generation" then
            -- Tenta pegar o valor de diferentes formas
            if descendant:IsA("NumberValue") or descendant:IsA("IntValue") then
                return descendant.Value
            elseif descendant:IsA("StringValue") then
                return tonumber(descendant.Value)
            elseif pcall(function() return descendant.Value end) then
                local val = descendant.Value
                if type(val) == "number" then
                    return val
                elseif type(val) == "string" then
                    return tonumber(val)
                end
            end
        end
    end
    return nil
end

-- WEBHOOK SEND
local function sendWebhook(foundPets, jobId)
    local petCounts = {}
    for _, petData in ipairs(foundPets) do
        local displayName = petData.name .. " (" .. petData.generation .. ")"
        petCounts[displayName] = (petCounts[displayName] or 0) + 1
    end

    local formattedPets = {}
    for petName, count in pairs(petCounts) do
        table.insert(formattedPets, petName .. (count > 1 and " x" .. count or ""))
    end

    local joinLink = buildJoinLink(game.PlaceId, jobId)

    local embedData = {
        username = "Clufin Notify Free",
        embeds = { {
            title = "ğŸ¾ Pet(s) Found!",
            description = "**Pet(s):**\n" .. table.concat(formattedPets, "\n"),
            color = 65280,
            fields = {
                {
                    name = "Players",
                    value = string.format("%d/%d", #Players:GetPlayers(), Players.MaxPlayers),
                    inline = true
                },
                {
                    name = "Job ID",
                    value = jobId,
                    inline = true
                },
                {
                    name = "Join Link",
                    value = string.format("[Click to join server](%s)", joinLink),
                    inline = false
                }
            },
            footer = { text = "Free Notify" },
            timestamp = DateTime.now():ToIsoDate()
        } }
    }

    local jsonData = HttpService:JSONEncode(embedData)
    local req = http_request or request or (syn and syn.request)
    if req then
        local success, err = pcall(function()
            req({
                Url = getgenv().webhook,
                Method = "POST",
                Headers = {["Content-Type"] = "application/json"},
                Body = jsonData
            })
        end)
        if success then
            print("âœ… Webhook sent")
        else
            warn("âŒ Webhook failed:", err)
        end
    else
        warn("âŒ No HTTP request function available")
    end
end

-- PET CHECK
local function checkForPets()
    local found = {}
    for _, obj in pairs(workspace:GetDescendants()) do
        if obj:IsA("Model") then
            local nameLower = string.lower(obj.Name)
            for _, target in pairs(getgenv().TargetPetNames) do
                if string.find(nameLower, string.lower(target)) then
                    -- Pega o valor do Generation
                    local genValue = getGenerationValue(obj)
                    local genDisplay = genValue and formatMoney(genValue) or "Unknown"
                    
                    table.insert(found, {
                        name = obj.Name,
                        generation = genDisplay
                    })
                    
                    print("âœ… Pet found:", obj.Name, "| Generation:", genDisplay)
                    break
                end
            end
        end
    end
    return found
end

-- MAIN LOOP
task.spawn(function()
    while true do
        local petsFound = checkForPets()
        if #petsFound > 0 then
            sendWebhook(petsFound, game.JobId)
        else
            print("ğŸ” No pets found")
        end
        task.wait(15)
    end
end)
