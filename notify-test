--CONFIG
getgenv().webhook = "https://discord.com/api/webhooks/1412573439662755991/totZqF-N-QytqQxFKM4GirpDF4j1Hjjyiy_a-RXBUdnjtg-4MAfW-Ve0h054IyvH8WiG"
getgenv().websiteEndpoint = nil

-- Allowed place IDs
local allowedPlaceIds = {
    [96342491571673] = true, -- New Players Server
    [109983668079237] = true -- Normal
}

getgenv().TargetPetNames = {
    "Noobini Pizzanini",
    "La Grande Combinasion", "Garama and Madundung", "Sammyni Spyderini",
    "Pot Hotspot",
    "Nuclearo Dinossauro",  
    "Chicleteira Bicicleteira", "Los Combinasionas", "Dragon Cannelloni",
    "Unclito Samito",
}

-- SERVICES
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local LocalPlayer = Players.LocalPlayer

-- PRIVATE SERVER CHECK (works for VIP + Reserved)
local function isPrivateServer()
    return (game.PrivateServerId and game.PrivateServerId ~= "")
        or (game.VIPServerId and game.VIPServerId ~= "")
end

local function buildJoinLink(placeId, jobId)
    return string.format(
        "https://chillihub1.github.io/chillihub-joiner/?placeId=%d&gameInstanceId=%s",
        placeId,
        jobId
    )
end

-- KICK CHECKS
if isPrivateServer() then
    LocalPlayer:Kick("Kicked because in private server")
    return
elseif not allowedPlaceIds[game.PlaceId] then
    local joinLink = buildJoinLink(game.PlaceId, game.JobId)
    LocalPlayer:Kick("Kicked because wrong game\nClick to join server:\n" .. joinLink)
    return
end

-- FORMAT MONEY VALUE
local function formatMoney(value)
    if value >= 1e12 then
        return string.format("$%.1fT/s", value / 1e12)
    elseif value >= 1e9 then
        return string.format("$%.1fB/s", value / 1e9)
    elseif value >= 1e6 then
        return string.format("$%.1fM/s", value / 1e6)
    elseif value >= 1e3 then
        return string.format("$%.1fK/s", value / 1e3)
    else
        return string.format("$%.2f/s", value)
    end
end

-- GET GENERATION FROM PET
local function getGeneration(petModel)
    -- Procura em toda a hierarquia do pet
    for _, child in pairs(petModel:GetDescendants()) do
        if child.Name == "Generation" then
            -- Se for um NumberValue ou IntValue
            if child:IsA("NumberValue") or child:IsA("IntValue") then
                if child.Value and child.Value > 0 then
                    return formatMoney(child.Value)
                end
            end
            -- Se tiver uma propriedade Value
            if child.Value then
                local numValue = tonumber(child.Value)
                if numValue and numValue > 0 then
                    return formatMoney(numValue)
                end
            end
        end
    end
    
    -- Se nÃ£o encontrou, retorna nil para nÃ£o incluir no webhook
    return nil
end

-- WEBHOOK SEND
local function sendWebhook(foundPets, jobId)
    local petData = {}
    for _, petInfo in ipairs(foundPets) do
        local key = petInfo.name .. " (" .. petInfo.generation .. ")"
        petData[key] = (petData[key] or 0) + 1
    end

    local formattedPets = {}
    for petName, count in pairs(petData) do
        table.insert(formattedPets, petName .. (count > 1 and " **x" .. count .. "**" or ""))
    end

    local joinLink = buildJoinLink(game.PlaceId, jobId)

    local embedData = {
        username = "ClufinOFC",
        embeds = { {
            title = "Brainrots Founds I Clufin NOTIFIER",
            description = "Pet(s):\n" .. table.concat(formattedPets, "\n"),
            color = 65280,
            fields = {
                {
                    name = "Players",
                    value = string.format("%d/%d", #Players:GetPlayers(), Players.MaxPlayers),
                    inline = true
                },
                {
                    name = "Job ID",
                    value = jobId,
                    inline = true
                },
                {
                    name = "Join Link",
                    value = string.format("[Click to join server](%s)", joinLink),
                    inline = false
                }
            },
            footer = { text = "ClufinOFC" },
            timestamp = DateTime.now():ToIsoDate()
        } }
    }

    local jsonData = HttpService:JSONEncode(embedData)
    local req = http_request or request or (syn and syn.request)
    if req then
        local success, err = pcall(function()
            req({
                Url = getgenv().webhook,
                Method = "POST",
                Headers = {["Content-Type"] = "application/json"},
                Body = jsonData
            })
        end)
        if success then
            print("âœ… Webhook sent")
        else
            warn("âŒ Webhook failed:", err)
        end
    else
        warn("âŒ No HTTP request function available")
    end
end

-- PET CHECK
local function checkForPets()
    local found = {}
    local processedPets = {} -- Para evitar duplicatas
    
    for _, obj in pairs(workspace:GetDescendants()) do
        if obj:IsA("Model") and not processedPets[obj] then
            local nameLower = string.lower(obj.Name)
            for _, target in pairs(getgenv().TargetPetNames) do
                local targetLower = string.lower(target)
                -- Verifica se o nome Ã© exatamente igual (nÃ£o apenas contÃ©m)
                if nameLower == targetLower or obj.Name == target then
                    processedPets[obj] = true
                    local generation = getGeneration(obj)
                    
                    -- Debug: mostra a estrutura do pet
                    print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
                    print("ğŸ” Pet encontrado:", obj.Name)
                    print("ğŸ“ Caminho completo:", obj:GetFullName())
                    print("ğŸ“‹ Descendentes:")
                    for _, desc in pairs(obj:GetDescendants()) do
                        if desc.Name == "Generation" or string.find(string.lower(desc.Name), "gen") then
                            print("  â”œâ”€", desc.Name, "â”‚", desc.ClassName, "â”‚ Value:", desc.Value or "N/A")
                        end
                    end
                    print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
                    
                    -- SÃ³ adiciona se encontrou um valor de geraÃ§Ã£o vÃ¡lido
                    if generation then
                        table.insert(found, {
                            name = obj.Name,
                            generation = generation
                        })
                        print("âœ… Adicionado com generation:", generation)
                    else
                        print("âš ï¸ Generation nÃ£o encontrado ou = 0")
                    end
                    break
                end
            end
        end
    end
    return found
end

-- MAIN LOOP
task.spawn(function()
    while true do
        local petsFound = checkForPets()
        if #petsFound > 0 then
            local petNames = {}
            for _, petInfo in ipairs(petsFound) do
                table.insert(petNames, petInfo.name .. " (" .. petInfo.generation .. ")")
            end
            print("âœ… Pets found:", table.concat(petNames, ", "))
            sendWebhook(petsFound, game.JobId)
        else
            print("ğŸ” No pets found")
        end
        task.wait(15)
    end
end)
