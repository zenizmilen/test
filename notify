--CONFIG
getgenv().webhook = "https://discord.com/api/webhooks/1412573439662755991/totZqF-N-QytqQxFKM4GirpDF4j1Hjjyiy_a-RXBUdnjtg-4MAfW-Ve0h054IyvH8WiG"
getgenv().websiteEndpoint = nil
getgenv().serverHopDelay = 1 -- Tempo em segundos antes de dar hop
getgenv().minPetValue = 1000000 -- Valor mÃ­nimo do pet (1M)

-- Allowed place IDs
local allowedPlaceIds = {
    [96342491571673] = true, -- New Players Server
    [109983668079237] = true -- Normal
}

-- SERVICES
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local LocalPlayer = Players.LocalPlayer

-- PRIVATE SERVER CHECK (works for VIP + Reserved)
local function isPrivateServer()
    return (game.PrivateServerId and game.PrivateServerId ~= "")
        or (game.VIPServerId and game.VIPServerId ~= "")
end

local function buildJoinLink(placeId, jobId)
    return string.format(
        "https://chillihub1.github.io/chillihub-joiner/?placeId=%d&gameInstanceId=%s",
        placeId,
        jobId
    )
end

-- KICK CHECKS
if isPrivateServer() then
    LocalPlayer:Kick("Kicked because in private server")
    return
elseif not allowedPlaceIds[game.PlaceId] then
    local joinLink = buildJoinLink(game.PlaceId, game.JobId)
    LocalPlayer:Kick("Kicked because wrong game\nClick to join server:\n" .. joinLink)
    return
end

-- FORMAT NUMBER
local function formatNumber(num)
    if num >= 1000000000 then
        return string.format("%.2fB", num / 1000000000)
    elseif num >= 1000000 then
        return string.format("%.2fM", num / 1000000)
    elseif num >= 1000 then
        return string.format("%.2fK", num / 1000)
    else
        return tostring(num)
    end
end

-- SERVER HOP FUNCTION
local function serverHop()
    print("ğŸ”„ Iniciando server hop...")
    
    local success, result = pcall(function()
        print("ğŸ“¡ Buscando lista de servidores...")
        local url = "https://games.roblox.com/v1/games/" .. game.PlaceId .. "/servers/Public?sortOrder=Asc&limit=100"
        print("URL:", url)
        
        local response = game:HttpGet(url)
        print("âœ… Resposta recebida")
        
        local servers = HttpService:JSONDecode(response)
        
        if servers and servers.data then
            print("ğŸ“Š Total de servidores encontrados:", #servers.data)
            local validServers = {}
            
            -- Filtra servidores (ignora o atual e servidores cheios)
            for _, server in pairs(servers.data) do
                if server.id ~= game.JobId and server.playing < server.maxPlayers then
                    table.insert(validServers, server)
                end
            end
            
            print("âœ… Servidores vÃ¡lidos:", #validServers)
            
            if #validServers > 0 then
                -- Escolhe um servidor aleatÃ³rio
                local randomServer = validServers[math.random(1, #validServers)]
                print("âœˆï¸ Teleportando para servidor com " .. randomServer.playing .. "/" .. randomServer.maxPlayers .. " jogadores")
                print("ğŸ†” Server ID:", randomServer.id)
                
                TeleportService:TeleportToPlaceInstance(
                    game.PlaceId,
                    randomServer.id,
                    LocalPlayer
                )
            else
                print("âš ï¸ Nenhum servidor disponÃ­vel, tentando teleporte normal...")
                TeleportService:Teleport(game.PlaceId, LocalPlayer)
            end
        else
            warn("âŒ Dados de servidores invÃ¡lidos")
        end
    end)
    
    if not success then
        warn("âŒ Erro no server hop:")
        warn(result)
        print("ğŸ”„ Tentando mÃ©todo alternativo...")
        
        -- Fallback: teleporte simples
        task.wait(2)
        local fallbackSuccess = pcall(function()
            TeleportService:Teleport(game.PlaceId, LocalPlayer)
        end)
        
        if not fallbackSuccess then
            warn("âŒ Falha no teleporte de fallback tambÃ©m!")
        end
    end
end

-- CHECK IF SERVER IS FULL
local function isServerFull()
    local currentPlayers = #Players:GetPlayers()
    local maxPlayers = Players.MaxPlayers
    return currentPlayers >= maxPlayers
end

-- GET PET NAME (procura o nome real do pet)
local function getPetName(petModel)
    -- Tenta encontrar o nome real do pet
    local petName = nil
    
    -- MÃ©todo 1: Procura em Configuration
    local config = petModel:FindFirstChild("Configuration")
    if config then
        local nameObj = config:FindFirstChild("PetName") or config:FindFirstChild("Name") or config:FindFirstChild("DisplayName")
        if nameObj and nameObj:IsA("StringValue") then
            petName = nameObj.Value
        end
    end
    
    -- MÃ©todo 2: Procura diretamente no model
    if not petName then
        local nameObj = petModel:FindFirstChild("PetName") or petModel:FindFirstChild("DisplayName")
        if nameObj and nameObj:IsA("StringValue") then
            petName = nameObj.Value
        end
    end
    
    -- MÃ©todo 3: Procura em Attributes
    if not petName then
        petName = petModel:GetAttribute("PetName") or petModel:GetAttribute("Name") or petModel:GetAttribute("DisplayName")
    end
    
    -- MÃ©todo 4: Procura por BillboardGui ou TextLabel
    if not petName then
        for _, descendant in pairs(petModel:GetDescendants()) do
            if descendant:IsA("BillboardGui") or descendant:IsA("SurfaceGui") then
                local textLabel = descendant:FindFirstChildOfClass("TextLabel")
                if textLabel and textLabel.Text ~= "" then
                    petName = textLabel.Text
                    break
                end
            end
        end
    end
    
    -- Se nÃ£o encontrou nada, usa o nome do Model (mas limpa se for GUID)
    if not petName then
        petName = petModel.Name
        -- Verifica se Ã© um GUID (formato: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx)
        if string.match(petName, "%x%x%x%x%x%x%x%x%-%x%x%x%x%-%x%x%x%x%-%x%x%x%x%-%x%x%x%x%x%x%x%x%x%x%x%x") then
            petName = "Unknown Pet"
        end
    end
    
    return petName
end

-- GET PET VALUE (procura no pet model por configuraÃ§Ãµes de valor)
local function getPetValue(petModel)
    -- Tenta encontrar o valor do pet em diferentes localizaÃ§Ãµes possÃ­veis
    local value = nil
    
    -- MÃ©todo 1: Procura por um valor em Configuration
    local config = petModel:FindFirstChild("Configuration")
    if config then
        local valueObj = config:FindFirstChild("Value") or config:FindFirstChild("Worth") or config:FindFirstChild("Price")
        if valueObj and (valueObj:IsA("NumberValue") or valueObj:IsA("IntValue")) then
            value = valueObj.Value
        end
    end
    
    -- MÃ©todo 2: Procura diretamente no model
    if not value then
        local valueObj = petModel:FindFirstChild("Value") or petModel:FindFirstChild("Worth") or petModel:FindFirstChild("Price")
        if valueObj and (valueObj:IsA("NumberValue") or valueObj:IsA("IntValue")) then
            value = valueObj.Value
        end
    end
    
    -- MÃ©todo 3: Procura em Attributes
    if not value then
        value = petModel:GetAttribute("Value") or petModel:GetAttribute("Worth") or petModel:GetAttribute("Price")
    end
    
    return value
end

-- WEBHOOK SEND
local function sendWebhook(foundPets, jobId)
    print("ğŸ“¤ Preparando webhook...")
    print("ğŸ¯ Pets para enviar:", #foundPets)
    
    local formattedPets = {}
    local totalValue = 0
    
    for _, petData in ipairs(foundPets) do
        local petName = petData.name
        local petValue = petData.value
        totalValue = totalValue + petValue
        table.insert(formattedPets, string.format("%s - **%s**", petName, formatNumber(petValue)))
        print("ğŸ“ Formatado:", petName, "-", formatNumber(petValue))
    end

    local joinLink = buildJoinLink(game.PlaceId, jobId)

    local embedData = {
        username = "Clufin & VNZ Notifier",
        embeds = { {
            title = "ğŸ¯ High Value Brainrots Found!",
            description = "**Brainrot(s) (1M+):**\n" .. table.concat(formattedPets, "\n") .. "\n\n**Total Value:** " .. formatNumber(totalValue),
            color = 65280,
            fields = {
                {
                    name = "Players",
                    value = string.format("%d/%d", #Players:GetPlayers(), Players.MaxPlayers),
                    inline = true
                },
                {
                    name = "Job ID",
                    value = jobId,
                    inline = true
                },
                {
                    name = "Join Link",
                    value = string.format("[Click to join server](%s)", joinLink),
                    inline = false
                }
            },
            footer = { text = "ClufinBOT" },
            timestamp = DateTime.now():ToIsoDate()
        } }
    }

    print("ğŸ”„ Convertendo para JSON...")
    local jsonData = HttpService:JSONEncode(embedData)
    print("âœ… JSON criado, tamanho:", #jsonData, "caracteres")
    
    local req = http_request or request or (syn and syn.request)
    if req then
        print("ğŸ“¡ Enviando webhook...")
        local success, err = pcall(function()
            req({
                Url = getgenv().webhook,
                Method = "POST",
                Headers = {["Content-Type"] = "application/json"},
                Body = jsonData
            })
        end)
        if success then
            print("âœ… Webhook enviado com sucesso!")
        else
            warn("âŒ Webhook failed:", err)
        end
    else
        warn("âŒ No HTTP request function available")
        warn("FunÃ§Ãµes testadas: http_request, request, syn.request")
    end
end

-- PET CHECK (verifica valor ao invÃ©s de nome)
local function checkForPets()
    local found = {}
    print("ğŸ” Iniciando busca por pets...")
    print("ğŸ“¦ Total de objetos no workspace:", #workspace:GetDescendants())
    
    local modelsChecked = 0
    for _, obj in pairs(workspace:GetDescendants()) do
        if obj:IsA("Model") then
            modelsChecked = modelsChecked + 1
            local petValue = getPetValue(obj)
            
            if petValue then
                print("ğŸ’° Model encontrado:", obj.Name, "| Valor:", petValue)
                
                if petValue >= getgenv().minPetValue then
                    local petName = getPetName(obj)
                    table.insert(found, {
                        name = petName,
                        value = petValue
                    })
                    print("âœ… Pet valioso adicionado:", petName, "| Valor:", formatNumber(petValue))
                end
            end
        end
    end
    
    print("ğŸ“Š Total de Models verificados:", modelsChecked)
    print("ğŸ’ Total de pets valiosos encontrados:", #found)
    
    return found
end

-- MAIN LOOP WITH SERVER HOP
local function startMainLoop()
    -- Verifica se o servidor jÃ¡ estÃ¡ cheio ao entrar
    if isServerFull() then
        print("ğŸš« Servidor estÃ¡ cheio! Dando hop imediatamente...")
        task.wait(2)
        serverHop()
        return
    end
    
    local checkCount = 0
    local maxChecksBeforeHop = 1 -- NÃºmero de verificaÃ§Ãµes antes de dar hop
    
    while true do
        -- Verifica se o servidor ficou cheio durante a execuÃ§Ã£o
        if isServerFull() then
            print("ğŸš« Servidor ficou cheio! Dando hop...")
            task.wait(2)
            serverHop()
            return
        end
        
        local petsFound = checkForPets()
        
        if #petsFound > 0 then
            print("âœ… High value pets found!")
            sendWebhook(petsFound, game.JobId)
            checkCount = 0 -- Reseta o contador quando encontra pets
        else
            checkCount = checkCount + 1
            print("ğŸ” No pets found (Check " .. checkCount .. "/" .. maxChecksBeforeHop .. ")")
            
            if checkCount >= maxChecksBeforeHop then
                print("â­ï¸ Nenhum pet encontrado apÃ³s " .. maxChecksBeforeHop .. " verificaÃ§Ãµes. Dando hop...")
                task.wait(2)
                serverHop()
                return -- Encerra o loop atual (serÃ¡ reiniciado no novo servidor)
            end
        end
        
        task.wait(getgenv().serverHopDelay)
    end
end

task.spawn(startMainLoop)

print("ğŸš€ Script iniciado! Procurando por brainrots com valor 1M+...")
